- name: Install apt packages
  ansible.builtin.apt:
    name:
      - antiword
      - autoconf
      - automake
      - bison
      - bzip2
      - ca-certificates
      - default-jre-headless
      - ffmpeg
      - flac
      - flex
      - g++
      - gawk
      - gettext
      - git
      - lame
      - libglib2.0-dev
      - libicu-dev
      - libjpeg-dev
      - libmad0
      - libsox-fmt-mp3
      - libtool
      - libxml2-dev
      - libxslt1-dev
      - lighttpd
      - make
      - pkgconf
      - poppler-utils
      - pstotext
      - python3
      - python3-dev
      - python3-lxml
      - python3-openpyxl
      - python3-pip
      - python3-requests
      - sox
      - swig
      - tesseract-ocr
      - unrtf
      - unzip

- name: Install Python packages
  ansible.builtin.pip:
    break_system_packages: true
    name:
      - torch
      - textract
      - twol # for ofitwol

- name: Configure lighttpd block
  block:
    - name: Read IP block list
      ansible.builtin.include_vars: ip_block_list.yaml
    - name: Install lighttpd configuration file
      ansible.builtin.template:
        src: templates/lighttpd.conf.j2
        dest: /etc/lighttpd/lighttpd.conf
    - name: Restart lighttpd
      ansible.builtin.systemd_service:
        name: lighttpd.service
        state: restarted

- name: Ensure directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0755
    owner: www-data
    group: www-data
  loop:
    - /var/www/cgi-bin
    - /var/www/tmp
    - /var/log/kielipankki-tools
    - /usr/local/share/histner
    - /usr/local/share/ofitwol
    - /usr/local/share/predict

- name: Set /var/www ownership
  ansible.builtin.file:
    owner: www-data
    group: www-data
    recurse: true
    path: /var/www

- name: Fetch git repos
  become_user: "{{ ansible_user }}"
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "/home/{{ ansible_user }}/{{ item.dir }}"
  loop:
    - dir: ofitwol
      repo: https://github.com/CSCfi/Kielipankki-ofitwol.git
    - dir: Kielipankki-demo
      repo: https://github.com/CSCfi/Kielipankki-demo.git
    - dir: conllu-viewer
      repo: https://github.com/CSCfi/Kielipankki-conllu-viewer.git
    - dir: nlp-tools
      repo: https://github.com/Traubert/nlp-tools.git
  tags: content

- name: Fetch software releases
  ansible.builtin.unarchive:
    remote_src: yes
    dest: "/home/{{ ansible_user }}/"
    src: "{{ item }}"
  loop:
    - https://github.com/hfst/hfst/releases/download/v3.16.0/hfst-3.16.0.tar.bz2
    - https://korp.csc.fi/download/finnish-tagtools/v1.6/finnish-tagtools-1.6.0.zip

- name: Unpack histner
  ansible.builtin.unarchive:
    remote_src: yes
    dest: "/usr/local/share/histner/"
    src: "/home/{{ ansible_user }}/Kielipankki-demo/files/histner.tar.gz"
    creates: "/usr/local/share/histner/hist-model-loc-prs.ser.gz"

- name: Build word embeddings library
  ansible.builtin.command:
    chdir: "/home/{{ ansible_user }}/nlp-tools/word_embeddings/c++/"
    cmd: make

- name: Build HFST
  ansible.builtin.command:
    chdir: "/home/{{ ansible_user }}/hfst-3.16.0/"
    cmd: "{{ item }}"
  loop:
    - "autoreconf -i"
    - >
      ./configure --with-unicode-handler=glib 
      --without-sfst 
      --without-foma 
      --enable-no-tools 
      --enable-lookup 
      --enable-tokenize 
      --enable-pmatch 
      --enable-optimized-lookup 
      --disable-dependency-tracking
    - "make -j 4"
    - "make install-strip"

- name: Build HFST's Python bindings
  ansible.builtin.command:
    chdir: "/home/{{ ansible_user }}/hfst-3.16.0/python"
    cmd: "{{ item }}"
  loop:
    - "python3 setup.py build_ext --inplace"
    - "python3 setup.py install"

- name: Install finnish-tagtools
  ansible.builtin.command:
    chdir: "/home/{{ ansible_user }}/finnish-tagtools-1.6.0/"
    cmd: "make install"
    
- name: Install scripts
  ansible.builtin.copy:
    remote_src: true
    src: "/home/{{ ansible_user }}/Kielipankki-demo/scripts/"
    dest: /usr/local/bin
    mode: 0755
  tags: content

- name: Build and install ofitwol
  ansible.builtin.command:
    chdir: "{{ item.dir }}"
    cmd: "{{ item.cmd }}"
  loop:
    - dir: "/home/{{ ansible_user }}/ofitwol/ofitwol/rules"
      cmd: make
    - dir: "/home/{{ ansible_user }}/ofitwol/ofitwol/ofi2"
      cmd: make ofitwol.ofst
    - dir: "/home/{{ ansible_user }}/ofitwol/ofitwol/ofi2"
      cmd: "cp ofitwol.ofst /usr/local/share/ofitwol/"
    - dir: "/home/{{ ansible_user }}/ofitwol/ofitwol/ofi2"
      cmd: make ofimphon.ofst
    - dir: "/home/{{ ansible_user }}/ofitwol/ofitwol/ofi2"
      cmd: "cp ofimphon.ofst /usr/local/share/ofitwol/"
    - dir: "/home/{{ ansible_user }}/ofitwol/ofitwol/ofi2"
      cmd: make ofiguess.ofst
    - dir: "/home/{{ ansible_user }}/ofitwol/ofitwol/ofi2"
      cmd: "cp ofiguess.ofst /usr/local/share/ofitwol/"




